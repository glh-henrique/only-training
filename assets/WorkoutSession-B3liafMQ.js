import{r as n,j as e}from"./vendor-RJ-jBvc8.js";import{a as q,u as pe,L as be,g as we,c as x}from"./index-DfMx629v.js";import{B as l}from"./button-D3CWm_we.js";import{I as je}from"./input-PBOW6J0D.js";import{A as G,M as Y}from"./alert-modal-C606l9RK.js";import{u as ke,T as H}from"./i18n-DvSS2Fqm.js";import{b as Ne,u as ve,c as ye}from"./router-Db51iocS.js";import{f as _e,g as J,h as Se,P as Q,V as X,i as Ce}from"./icons-CewslWSu.js";import"./supabase-BfAM1BYj.js";function Le(){var K;const{t}=ke(),{workoutId:a}=Ne(),c=ve(),Z=ye(),[ee,v]=n.useState(!1),[R,p]=n.useState(!1),[y,b]=n.useState(!1),[T,w]=n.useState(!1),[j,z]=n.useState(null),[d,L]=n.useState(null),[se,te]=n.useState(""),[re,_]=n.useState(!1),{currentSession:o,sessionItems:k,startSession:S,duration:ae,finishSession:ne,toggleItemDone:le,updateItemStats:oe,resumeSession:O,finishAllInProgressSessions:ie,restartSession:ce,isLoading:N,error:F}=q(),{workouts:C,fetchWorkouts:V,activeWorkoutItems:I,fetchWorkoutItems:B}=pe(),D=!N&&o&&a&&o.workout_id!==a,r=!!o&&!!a&&o.workout_id===a,P=!!((K=Z.state)!=null&&K.autoStart),M=new Date(ae*1e3).toISOString().substr(14,5),h=r?k.length:I.length,m=r?k.filter(s=>s.is_done).length:0,de=r&&h>0?m/h*100:0,[A,ue]=n.useState(!0);n.useEffect(()=>{let s=!0;return O().finally(()=>{s&&ue(!1)}),()=>{s=!1}},[O]),n.useEffect(()=>{a&&(C.length===0&&V(),B(a))},[a,V,B,C.length]),n.useEffect(()=>{if(d==null||d<=0)return;const s=setInterval(()=>{L(i=>i==null?i:i<=1?0:i-1)},1e3);return()=>clearInterval(s)},[d]),n.useEffect(()=>{if(d!==0||!j)return;(()=>{try{const i=window.AudioContext||window.webkitAudioContext,u=new i,g=u.createOscillator(),W=u.createGain();g.type="sine",g.frequency.value=880,W.gain.value=.2,g.connect(W),W.connect(u.destination),g.start(),g.stop(u.currentTime+.5),g.onended=()=>u.close()}catch{}})(),_(!0),z(null)},[d,j]);const xe=(s,i,u)=>{!i||i<=0||(z(s),te(u),L(i))};n.useEffect(()=>{!A&&!N&&!o&&a&&!y&&P&&(async()=>(w(!0),await S(a)==="no_items"&&c(`/workout/${a}/edit`),w(!1)))()},[A,N,o,a,S,y,c,P]);const U=async()=>{if(!a||T)return;w(!0),await S(a)==="no_items"&&c(`/workout/${a}/edit`),w(!1)},f=C.find(s=>s.id===a),he=n.useMemo(()=>I.map(s=>({id:s.id,title:s.title,restSeconds:s.rest_seconds,notes:s.notes,videoUrl:s.video_url,isDone:!1,weight:s.default_weight,sets:s.default_sets,reps:s.default_reps})),[I]),me=n.useMemo(()=>k.map(s=>({id:s.id,title:s.title_snapshot,restSeconds:s.rest_seconds,notes:s.notes_snapshot,videoUrl:s.video_url,isDone:s.is_done,weight:s.weight,sets:s.sets,reps:s.reps})),[k]),$=r?me:he,fe=async()=>{b(!0),await ne(),c("/")},E=async()=>{if(console.log("[WorkoutSession] handleCancel called",{isConflict:D,workoutId:a}),!!a){b(!0),p(!1);try{D?(await ce(a),b(!1)):(await ie(),c("/"))}catch(s){console.error("[WorkoutSession] handleCancel failed:",s),b(!1)}}},ge=()=>{o&&c(`/workout/${o.workout_id}`)};return A||N||y||T?e.jsx(be,{fullPage:!0}):F?e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center bg-white dark:bg-neutral-950 text-neutral-900 dark:text-white p-6 text-center space-y-4 transition-colors",children:[e.jsx("div",{className:"bg-red-500/10 p-4 rounded-full text-red-500",children:e.jsx(_e,{className:"h-10 w-10"})}),e.jsx("h2",{className:"text-xl font-bold",children:t("common.error","Something went wrong")}),e.jsx("p",{className:"text-sm text-neutral-500 max-w-xs",children:F}),e.jsx(l,{onClick:()=>{q.setState({error:null}),c("/")},children:t("common.back_to_home","Back to Home")})]}):D?e.jsxs("div",{className:"min-h-screen bg-white dark:bg-neutral-950 text-neutral-900 dark:text-white flex flex-col items-center justify-center p-6 text-center space-y-6 transition-colors",children:[e.jsx("div",{className:"bg-yellow-500/10 p-4 rounded-full",children:e.jsx(J,{className:"h-10 w-10 text-yellow-500"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xl font-bold",children:t("session.conflict.title")}),e.jsx("div",{className:"text-neutral-600 dark:text-neutral-400",children:e.jsxs(H,{i18nKey:"session.conflict.description",values:{workout:o.workout_name_snapshot},children:["You have an active session for ",e.jsx("span",{className:"text-emerald-500 font-semibold",children:o.workout_name_snapshot}),"."]})}),e.jsx("p",{className:"text-sm text-neutral-500",children:t("session.conflict.question")})]}),e.jsxs("div",{className:"flex flex-col w-full gap-3 max-w-xs",children:[e.jsx(l,{onClick:ge,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white",children:t("session.conflict.resume",{workout:o.workout_name_snapshot})}),e.jsx(l,{variant:"outline",onClick:()=>p(!0),className:"w-full text-red-500 border-red-200 dark:border-red-900/50 hover:bg-red-50 dark:hover:bg-red-950/30",children:t("session.conflict.discard","Discard & Start New")}),e.jsx(l,{variant:"ghost",onClick:()=>c("/"),className:"text-neutral-500",children:t("common.cancel")})]}),e.jsx(G,{isOpen:R,onClose:()=>{console.log("[WorkoutSession/Conflict] Closing Discard Modal"),p(!1)},onConfirm:E,variant:"danger",title:t("session.discard_modal_title","Discard Session?"),description:t("session.discard_modal_desc","Are you sure you want to discard this session? All currently recorded data will be lost."),confirmLabel:t("session.conflict.discard","Discard")})]}):e.jsxs("div",{className:"min-h-screen bg-white dark:bg-neutral-950 text-neutral-900 dark:text-white pb-24 transition-colors",children:[e.jsxs("header",{className:"fixed top-0 left-0 right-0 bg-white/90 dark:bg-neutral-900/90 backdrop-blur z-10 transition-all border-b border-neutral-200 dark:border-neutral-800",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>c("/"),className:"text-neutral-500 dark:text-neutral-400",children:e.jsx(Se,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-lg leading-tight text-neutral-900 dark:text-white",children:r?o.workout_name_snapshot:(f==null?void 0:f.name)||t("common.loading","Loading")}),e.jsx("p",{className:"text-xs text-neutral-500 dark:text-neutral-400",children:r?o.workout_focus_snapshot:(f==null?void 0:f.focus)||t("session.not_started","Workout not started")})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 font-mono text-xl font-bold text-emerald-600 dark:text-emerald-500 bg-emerald-500/10 px-3 py-1 rounded-md",children:[e.jsx(J,{className:"h-4 w-4"}),M]}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>p(!0),className:"text-red-500 hover:text-red-400 hover:bg-red-500/10",children:t("common.cancel")})]}):e.jsxs(l,{onClick:U,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),t("workouts.start_workout")]})})]}),e.jsx("div",{className:"h-1 w-full bg-neutral-100 dark:bg-neutral-800",children:e.jsx("div",{className:"h-full bg-emerald-500 transition-all duration-500 ease-out",style:{width:`${de}%`}})})]}),e.jsxs("div",{className:x("pt-24 px-4 space-y-4",!r&&"opacity-80"),children:[$.length===0&&(r?e.jsxs("div",{className:"text-center py-10 space-y-4",children:[e.jsx("p",{className:"text-neutral-400",children:t("history.no_sessions")}),e.jsx("p",{className:"text-sm text-neutral-500",children:t("session.empty_help","If you recently added exercises to this workout, this session might be using an old snapshot. Discarding it will let you start a fresh one.")}),e.jsx(l,{variant:"outline",onClick:E,className:"text-red-400 border-red-900/50 hover:bg-red-950/30",children:t("session.conflict.discard","Discard & Restart")})]}):e.jsxs("div",{className:"text-center py-10 space-y-4",children:[e.jsx("p",{className:"text-neutral-400",children:t("workouts.no_items","No exercises yet")}),e.jsx(l,{variant:"outline",onClick:()=>c(`/workout/${a}/edit`),className:"text-emerald-500 border-emerald-500/30 hover:bg-emerald-500/10",children:t("workouts.edit","Edit Workout")})]})),$.map(s=>{const i=we(s.videoUrl);return e.jsxs("div",{className:x("bg-neutral-50 dark:bg-neutral-900 rounded-xl p-4 border transition-all",s.isDone?"border-emerald-500/50 bg-emerald-50 dark:bg-emerald-950/10":"border-neutral-200 dark:border-neutral-800"),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:x("font-medium text-lg",s.isDone?"text-neutral-400 dark:text-neutral-500 line-through":"text-neutral-900 dark:text-white"),children:s.title}),i&&(r?e.jsxs("a",{href:i,target:"_blank",rel:"noreferrer",className:"inline-flex items-center gap-2 text-xs text-emerald-600 hover:text-emerald-700",children:[e.jsx("span",{children:"Video Exemplo"}),e.jsx(X,{className:"h-4 w-4"})]}):e.jsxs("span",{className:"inline-flex items-center gap-2 text-xs text-neutral-400",children:[e.jsx("span",{children:"Video Exemplo"}),e.jsx(X,{className:"h-4 w-4"})]}))]}),e.jsx("button",{onClick:()=>{r&&le(s.id,!s.isDone)},disabled:!r,className:x("h-8 w-8 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0",!r&&"opacity-50 cursor-not-allowed",s.isDone?"bg-emerald-500 border-emerald-500 text-black":"border-neutral-600 hover:border-emerald-500"),children:s.isDone&&e.jsx(Ce,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-neutral-500 mb-1 block",children:[t("common.weight")," (kg)"]}),e.jsx(je,{type:"number",value:s.weight??"",onChange:u=>{r&&oe(s.id,Number(u.target.value),s.reps??"")},disabled:!r||s.isDone,className:x("bg-white dark:bg-neutral-950 border-neutral-200 dark:border-neutral-800 h-10 transition-opacity text-neutral-900 dark:text-white",(!r||s.isDone)&&"opacity-50 cursor-not-allowed")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-neutral-500 mb-1 block",children:[t("common.sets")," (",t("session.target","Target"),")"]}),e.jsx("div",{className:"h-10 px-3 flex items-center text-neutral-900 dark:text-white font-medium text-lg",children:s.sets??"-"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-neutral-500 mb-1 block",children:[t("common.reps")," (",t("session.target","Target"),")"]}),e.jsx("div",{className:"h-10 px-3 flex items-center text-neutral-900 dark:text-white font-medium text-lg",children:s.reps??"-"})]})]}),s.restSeconds!=null&&e.jsx("div",{className:"mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-800",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("p",{className:"text-sm text-neutral-500 dark:text-neutral-400",children:[t("common.rest"),": ",s.restSeconds,"s"]}),e.jsx(l,{size:"sm",variant:"outline",onClick:()=>{r&&xe(s.id,s.restSeconds,s.title)},disabled:!r||j===s.id&&d!=null&&d>0,className:x("text-emerald-600 border-emerald-500/30 hover:bg-emerald-500/10",!r&&"opacity-50 cursor-not-allowed"),children:j===s.id&&d!=null?t("session.rest_running",{seconds:d}):t("session.start_rest")})]})}),s.notes&&e.jsx("div",{className:"mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-800",children:e.jsxs("p",{className:"text-sm text-neutral-500 dark:text-neutral-400 italic",children:[t("common.notes"),": ",s.notes]})})]},s.id)})]}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent space-y-2",children:r?e.jsx(l,{size:"lg",disabled:m<3&&h>=3,className:x("w-full font-bold h-14 text-lg shadow-lg transition-all",m<3&&h>=3?"bg-neutral-800 text-neutral-500 cursor-not-allowed shadow-none":"bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-900/50"),onClick:()=>v(!0),children:e.jsxs("span",{className:"flex flex-col items-center leading-tight",children:[e.jsx("span",{children:t("session.finish")}),m<3&&h>=3&&e.jsx("span",{className:"text-xs font-normal opacity-80",children:t("session.finish_hint",{count:3,current:m})})]})}):e.jsx(l,{size:"lg",className:"w-full font-bold h-14 text-lg shadow-lg transition-all bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-900/50",onClick:U,children:e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5"}),e.jsx("span",{children:t("workouts.start_workout")})]})})}),r&&e.jsx(Y,{isOpen:ee,onClose:()=>v(!1),title:t("session.finish_modal_title","Finish Workout?"),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-neutral-300",children:e.jsxs(H,{i18nKey:"session.finish_modal_desc",values:{formattedTime:M},children:["Great job! You've been training for ",e.jsx("span",{className:"text-emerald-500 font-bold",children:M}),"."]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(l,{variant:"outline",className:"flex-1",onClick:()=>v(!1),children:t("session.keep_training","Keep Training")}),e.jsx(l,{className:"flex-1 bg-emerald-600 text-white",onClick:fe,disabled:m<3&&h>=3,children:t("session.finish")})]})]})}),r&&e.jsx(G,{isOpen:R,onClose:()=>{console.log("[WorkoutSession] Closing Discard Modal"),p(!1)},onConfirm:E,variant:"danger",title:t("session.discard_modal_title","Discard Session?"),description:t("session.discard_modal_desc","Are you sure you want to discard this session? All currently recorded data will be lost."),confirmLabel:t("session.conflict.discard","Discard")}),e.jsx(Y,{isOpen:re,onClose:()=>_(!1),title:t("session.rest_done_title"),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-neutral-300",children:t("session.rest_done_desc",{exercise:se})}),e.jsx(l,{className:"w-full bg-emerald-600 text-white",onClick:()=>_(!1),children:t("common.ok","OK")})]})})]})}export{Le as default};
