import{r as l,j as e}from"./vendor-RJ-jBvc8.js";import{b as M,s as i}from"./index-CJN2Yibc.js";import{B as v}from"./button-eI2RqdAi.js";import{I as E}from"./input-BQh-um8q.js";import{u as O}from"./i18n-DvSS2Fqm.js";import{h as G,M as F,t as H,U as J,u as q,n as K}from"./icons-CewslWSu.js";import{u as Q}from"./router-Db51iocS.js";import"./supabase-BfAM1BYj.js";function ae(){const{t}=O(),h=Q(),{user:m}=M(),[j,L]=l.useState([]),[D,A]=l.useState(0),[B,P]=l.useState(0),[R,_]=l.useState({}),[f,k]=l.useState(""),[p,w]=l.useState(null),[N,b]=l.useState(null),[T,y]=l.useState(!1),[C,o]=l.useState(null),g=async()=>{if(m){y(!0),o(null);try{const[{data:s,error:n},{data:r,error:c},{data:x,error:a}]=await Promise.all([i.from("coach_student_links").select("*").eq("coach_id",m.id).order("created_at",{ascending:!1}),i.from("coach_student_invites").select("*").eq("coach_id",m.id).order("created_at",{ascending:!1}),i.from("coach_student_unlink_requests").select("*").order("created_at",{ascending:!1})]);if(n)throw n;if(c)throw c;if(a)throw a;L(s||[]),A((r||[]).length),P((x||[]).filter(u=>u.status==="pending").length);const d=Array.from(new Set((s||[]).map(u=>u.student_id)));if(d.length>0){const{data:u,error:I}=await i.from("profiles").select("*").in("user_id",d);if(I)throw I;const $=Object.fromEntries((u||[]).map(S=>[S.user_id,S]));_($)}else _({})}catch(s){o(s.message)}finally{y(!1)}}};l.useEffect(()=>{g()},[m]);const z=async s=>{var n;if(s.preventDefault(),!!f.trim()){o(null),w(null),b(null);try{const{data:r,error:c}=await i.auth.getSession();if(c)throw c;const x=(n=r.session)==null?void 0:n.access_token;if(!x)throw new Error(t("coach.panel.auth_required"));const{data:a,error:d}=await i.functions.invoke("send-coach-invite",{headers:{Authorization:`Bearer ${x}`},body:{studentEmail:f.trim()}});if(d)throw d;a!=null&&a.success&&(a!=null&&a.sent)?b(t("coach.panel.invite_sent_success")):a!=null&&a.inviteLink&&(w(a.inviteLink),b(t("coach.panel.invite_sent_fallback"))),k(""),await g()}catch(r){o(r.message)}}},U=async(s,n)=>{o(null);try{const{error:r}=await i.from("coach_student_links").update({student_can_unlink:n}).eq("id",s.id);if(r)throw r;await g()}catch(r){o(r.message)}};return e.jsxs("div",{className:"min-h-screen bg-white dark:bg-neutral-950 text-neutral-900 dark:text-white pb-20",children:[e.jsxs("header",{className:"p-4 flex items-center gap-4 border-b border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-950 sticky top-0 z-10",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>h("/profile"),children:e.jsx(G,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl font-bold",children:t("coach.panel.title")})]}),e.jsxs("main",{className:"p-4 max-w-3xl mx-auto space-y-6",children:[e.jsxs("section",{className:"bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5 text-emerald-500"}),e.jsx("h2",{className:"font-semibold",children:t("coach.panel.invite_title")})]}),e.jsxs("form",{onSubmit:z,className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(E,{type:"email",value:f,onChange:s=>k(s.target.value),placeholder:t("coach.panel.invite_email_placeholder"),required:!0}),e.jsx(v,{type:"submit",children:t("coach.panel.invite_submit")})]}),p&&e.jsxs("div",{className:"p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-sm space-y-2",children:[e.jsx("p",{children:t("coach.panel.invite_link_ready")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{value:p,readOnly:!0}),e.jsx(v,{type:"button",variant:"outline",onClick:async()=>{await navigator.clipboard.writeText(p)},children:e.jsx(H,{className:"h-4 w-4"})})]})]}),N&&e.jsx("div",{className:"p-3 rounded-lg bg-blue-500/10 text-blue-600 text-sm",children:N})]}),e.jsxs("section",{className:"bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-emerald-500"}),e.jsx("h2",{className:"font-semibold",children:t("coach.panel.students_title")})]}),j.length===0?e.jsx("p",{className:"text-sm text-neutral-500 dark:text-neutral-400",children:t("coach.panel.no_students")}):e.jsx("div",{className:"space-y-2",children:j.map(s=>{const n=R[s.student_id];return e.jsxs("div",{className:"p-3 rounded-xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-950 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("button",{className:"font-semibold text-left hover:text-emerald-500 transition-colors",onClick:()=>h(`/coach-student-workouts?student=${s.student_id}`),children:(n==null?void 0:n.full_name)||t("coach.workouts.unnamed_student")}),e.jsx("p",{className:"text-xs text-neutral-500",children:t(`coach.common.status.${s.status}`)})]}),s.status==="active"&&e.jsxs("label",{className:"text-xs flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.student_can_unlink,onChange:r=>U(s,r.target.checked)}),t("coach.panel.student_can_unlink")]})]},s.id)})})]}),e.jsxs("section",{className:"bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl overflow-hidden",children:[e.jsxs("button",{className:"w-full p-4 flex items-center justify-between hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors",onClick:()=>h("/coach-invites"),children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-semibold",children:t("coach.panel.invites_title")}),e.jsx("p",{className:"text-xs text-neutral-500",children:t("coach.panel.invites_count",{count:D})})]}),e.jsx(q,{className:"h-4 w-4 text-neutral-500"})]}),e.jsxs("button",{className:"w-full p-4 flex items-center justify-between border-t border-neutral-200 dark:border-neutral-800 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors",onClick:()=>h("/coach-unlink-requests"),children:[e.jsxs("div",{className:"text-left flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-amber-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t("coach.panel.unlink_requests_title")}),e.jsx("p",{className:"text-xs text-neutral-500",children:t("coach.panel.unlink_requests_count",{count:B})})]})]}),e.jsx(q,{className:"h-4 w-4 text-neutral-500"})]})]}),T&&e.jsx("p",{className:"text-sm text-neutral-500",children:t("common.loading")}),C&&e.jsx("p",{className:"text-sm text-red-500",children:C})]})]})}export{ae as default};
