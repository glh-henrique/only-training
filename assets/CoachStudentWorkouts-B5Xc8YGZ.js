import{r as x,j as t}from"./vendor-RJ-jBvc8.js";import{s as m}from"./index-DfMx629v.js";import{B as h}from"./button-D3CWm_we.js";import{I as S}from"./input-PBOW6J0D.js";import{u as T}from"./i18n-DvSS2Fqm.js";import{h as U,v as $,u as O,c as H,l as J,A as K,b as Q}from"./icons-CewslWSu.js";import{u as V,d as X}from"./router-Db51iocS.js";import"./supabase-BfAM1BYj.js";function oe(){const{t:n}=T(),j=V(),[z]=X(),p=z.get("student"),[f,l]=x.useState([]),[N,v]=x.useState(!1),[b,i]=x.useState(null),F=x.useMemo(()=>f.length,[f.length]),q=async()=>{var e;v(!0),i(null);try{const{data:r}=await m.auth.getUser(),s=(e=r.user)==null?void 0:e.id;if(!s)throw new Error("User not authenticated");const{data:o,error:a}=await m.from("coach_student_links").select("*").eq("coach_id",s).eq("status","active");if(a)throw a;const u=Array.from(new Set((o||[]).map(c=>c.student_id)));if(u.length===0){l([]);return}const[{data:G,error:I},{data:L,error:W}]=await Promise.all([m.from("profiles").select("*").in("user_id",u),m.from("workouts").select("*").in("user_id",u).eq("is_archived",!1).order("created_at",{ascending:!1})]);if(I)throw I;if(W)throw W;const C=Object.fromEntries((G||[]).map(c=>[c.user_id,c])),w=new Map;(L||[]).forEach(c=>{const d=w.get(c.user_id)||[];d.push(c),w.set(c.user_id,d)}),l(c=>u.map(d=>{var g,E;const k=c.find(R=>R.studentId===d),M=p===d;return{studentId:d,studentName:((g=C[d])==null?void 0:g.full_name)||n("coach.workouts.unnamed_student"),studentGym:((E=C[d])==null?void 0:E.gym_name)??null,expanded:M?!0:(k==null?void 0:k.expanded)??!1,workouts:w.get(d)||[],creating:!1,newWorkoutName:"",newWorkoutFocus:""}}))}catch(r){i(r.message)}finally{v(!1)}};x.useEffect(()=>{q()},[p]);const D=e=>{l(r=>r.map(s=>s.studentId===e?{...s,expanded:!s.expanded}:s))},_=(e,r)=>{l(s=>s.map(o=>o.studentId===e?{...o,creating:r}:o))},y=(e,r,s)=>{l(o=>o.map(a=>a.studentId===e?{...a,[r]:s}:a))},A=async e=>{if(!(!e.newWorkoutName.trim()||!e.newWorkoutFocus.trim())){i(null);try{const{data:r,error:s}=await m.from("workouts").insert({user_id:e.studentId,name:e.newWorkoutName.trim(),focus:e.newWorkoutFocus.trim()}).select("*").single();if(s)throw s;l(o=>o.map(a=>a.studentId===e.studentId?{...a,workouts:[r,...a.workouts],creating:!1,newWorkoutName:"",newWorkoutFocus:""}:a))}catch(r){i(r.message)}}},P=async(e,r)=>{i(null);try{const{error:s}=await m.from("workouts").update({is_archived:!0}).eq("id",r).eq("user_id",e.studentId);if(s)throw s;l(o=>o.map(a=>a.studentId===e.studentId?{...a,workouts:a.workouts.filter(u=>u.id!==r)}:a))}catch(s){i(s.message)}},B=async(e,r)=>{if(window.confirm(n("workouts.delete_desc_full"))){i(null);try{const{error:s}=await m.from("workouts").delete().eq("id",r).eq("user_id",e.studentId);if(s)throw s;l(o=>o.map(a=>a.studentId===e.studentId?{...a,workouts:a.workouts.filter(u=>u.id!==r)}:a))}catch(s){i(s.message)}}};return t.jsxs("div",{className:"min-h-screen bg-white dark:bg-neutral-950 text-neutral-900 dark:text-white pb-20",children:[t.jsxs("header",{className:"p-4 flex items-center gap-4 border-b border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-950 sticky top-0 z-10",children:[t.jsx(h,{variant:"ghost",size:"icon",onClick:()=>j("/coach-panel"),children:t.jsx(U,{className:"h-5 w-5"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold",children:n("coach.workouts.title")}),t.jsx("p",{className:"text-xs text-neutral-500",children:n("coach.workouts.subtitle",{count:F})})]})]}),t.jsxs("main",{className:"p-4 max-w-4xl mx-auto space-y-3",children:[N&&t.jsx("p",{className:"text-sm text-neutral-500",children:n("common.loading")}),b&&t.jsx("p",{className:"text-sm text-red-500",children:b}),!N&&f.length===0&&t.jsx("div",{className:"rounded-xl border border-neutral-200 dark:border-neutral-800 p-4 text-sm text-neutral-500",children:n("coach.workouts.no_students")}),f.map(e=>{var r;return t.jsxs("section",{className:"rounded-xl border border-neutral-200 dark:border-neutral-800 overflow-hidden",children:[t.jsxs("button",{className:"w-full px-4 py-3 flex items-center justify-between bg-neutral-50 dark:bg-neutral-900 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors",onClick:()=>D(e.studentId),children:[t.jsxs("div",{className:"text-left",children:[t.jsx("p",{className:"font-semibold",children:e.studentName}),(r=e.studentGym)!=null&&r.trim()?t.jsx("p",{className:"text-xs text-neutral-500",children:n("profile.training_at",{gym:e.studentGym.trim()})}):null,t.jsx("p",{className:"text-xs text-neutral-500",children:n("coach.workouts.count",{count:e.workouts.length})})]}),e.expanded?t.jsx($,{className:"h-5 w-5"}):t.jsx(O,{className:"h-5 w-5"})]}),e.expanded&&t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsx("div",{className:"flex justify-end",children:e.creating?t.jsxs("div",{className:"w-full grid grid-cols-1 md:grid-cols-[2fr_2fr_auto_auto] gap-2",children:[t.jsx(S,{value:e.newWorkoutName,onChange:s=>y(e.studentId,"newWorkoutName",s.target.value),placeholder:n("common.name")}),t.jsx(S,{value:e.newWorkoutFocus,onChange:s=>y(e.studentId,"newWorkoutFocus",s.target.value),placeholder:n("home.focus")}),t.jsx(h,{size:"sm",onClick:()=>A(e),children:n("common.create")}),t.jsx(h,{size:"sm",variant:"outline",onClick:()=>_(e.studentId,!1),children:n("common.cancel")})]}):t.jsxs(h,{size:"sm",onClick:()=>_(e.studentId,!0),children:[t.jsx(H,{className:"h-4 w-4 mr-1"}),n("coach.workouts.create")]})}),e.workouts.length===0?t.jsx("p",{className:"text-sm text-neutral-500",children:n("home.no_workouts")}):t.jsx("div",{className:"space-y-2",children:e.workouts.map(s=>t.jsxs("div",{className:"rounded-lg border border-neutral-200 dark:border-neutral-800 p-3 flex items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"font-semibold",children:s.name}),t.jsx("p",{className:"text-xs text-neutral-500",children:s.focus})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(h,{size:"icon",variant:"ghost",onClick:()=>j(`/workout/${s.id}/edit?owner=${e.studentId}`),children:t.jsx(J,{className:"h-4 w-4"})}),t.jsx(h,{size:"icon",variant:"ghost",onClick:()=>P(e,s.id),children:t.jsx(K,{className:"h-4 w-4 text-amber-500"})}),t.jsx(h,{size:"icon",variant:"ghost",onClick:()=>B(e,s.id),children:t.jsx(Q,{className:"h-4 w-4 text-red-500"})})]})]},s.id))})]})]},e.studentId)})]})]})}export{oe as default};
